#!/bin/bash

LIST="http://vpn.hidemyass.com/vpnconfig/countries.php"
CLCONF="http://vpn.hidemyass.com/vpnconfig/client_config.php?win=1&loc="

if [ $# == 0 ] || [ $# -gt 2 ]; then echo "Usage: $0 [OPTION]"; exit 1; fi

cd $(dirname $0)

fun () { echo "$1"| sed 's/ /+/g' ; }

case "$1" in
    -l)     curl -s $LIST; exit ;;

    -ip)    [ "$2" ] && TMP=$(fun "$2") && echo -n "$2: " && \
        curl -s "$CLCONF$TMP"| tail| grep remote| cut -d " " -f 2 || \
        echo "Invalid host! "
        exit ;;
        
    -r)    TMP=$(curl -s $LIST| sort -R| head -n 1| sed 's/[ \t]*$//') ;;

    -i)    [ "$2" ] && TMP=$(curl -s $LIST| grep "$2"| sort -R| head -n 1| sed 's/[ \t]*$//')
        [ ! "$TMP" ] && echo "Keyword not found." ;;

    -o)    [ "$2" ] && TMP=$(curl -s $LIST| grep -v "$2"| sort -R| head -n 1| sed 's/[ \t]*$//')
        [ ! "$TMP" ] && echo "Keyword not found." ;;

    *)    curl -s $LIST| sed 's/[ \t]*$//'| grep -x "$1" && TMP="$1" || echo "Unknown argument! " ;;
esac

[ "$TMP" ] && VPN=$(fun "$TMP") || exit 2

echo "VPN chosen: $TMP"
curl -s "$CLCONF$VPN" > client.cfg
[ -f /root/hmaauth.conf ] && \
sudo openvpn --config client.cfg --auth-user-pass /root/hmaauth.conf || \
sudo openvpn --config client.cfg
